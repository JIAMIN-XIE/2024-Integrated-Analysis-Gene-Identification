#Chip-Seq analysis of GEO dataset GSE174602 (ChIP-Seq in SOX4 (HA-SOX4) decidualized human endometrial stromal cells).
micromamba activateEnv_Homer
# STEP 1: Download ChIP-seq dataset from GSE174602
#-----------------------------------------------
 
# Create a directory structure for the project
# ~/GSE174602/ is the main project directory
# ~/GSE174602/raw/ stores the raw sequencing files
mkdir -p ~/GSE174602/raw # Changed directory name to match the new GEO dataset
cd ~/GSE174602/raw
 
# Download ChIP-seq data from GEO dataset GSE174602
# The data is paired-end data
 
# Download CONTROL sample (Input DNA) - SRR14574895
echo "Downloading control (Input) sample SRR14574895..."
prefetch SRR14574895
# Convert SRA to FASTQ format
fasterq-dump --split-files SRR14574895/SRR14574895.sra

 
# Download HA-SOX4 ChIP sample - SRR14574894
echo "Downloading HA-SOX4 ChIP sample SRR14574894..."
prefetch SRR14574894
fasterq-dump --split-files SRR14574894/SRR14574894.sra

 
# Compress the FASTQ files to save disk space
# gzip compression is standard for NGS data
echo "Compressing FASTQ files..."
gzip *.fastq
 
# Remove the temporary SRA directories to save space
echo "Cleaning up SRA directories..."
rm -r SRR14574895 SRR14574894
 
# Rename the FASTQ files to more descriptive names
# Rename the R1 and R2 files separately using wildcards
echo "Renaming files with descriptive names..."

# Rename SRR14574894 (ChIP sample)
mv SRR14574894_1.fastq.gz SRR14574894_SOX4_ChIP_R1.fastq.gz
mv SRR14574894_2.fastq.gz SRR14574894_SOX4_ChIP_R2.fastq.gz

# Rename SRR14574895 (Input sample)
mv SRR14574895_1.fastq.gz SRR14574895_Input_R1.fastq.gz
mv SRR14574895_2.fastq.gz SRR14574895_Input_R2.fastq.gz
 
echo "Dataset download complete! Files are ready for paired-end alignment."


#-----------------------------------------------
# STEP 2: Quality control and adapter trimming
#-----------------------------------------------
 
# Create a directory for trimmed FASTQ files
mkdir -p ~/GSE174602/trim
 
 
# Trim adapters and low-quality bases from the HA-SOX4 ChIP sample
echo "Processing HA-SOX4 ChIP sample (Paired-End)..."
trim_galore --fastqc --cores 8 --quality 20 --stringency 3 --length 20 --paired \
    -o ~/GSE174602/trim \
    ~/GSE174602/raw/SRR14574894_SOX4_ChIP_R1.fastq.gz \
    ~/GSE174602/raw/SRR14574894_SOX4_ChIP_R2.fastq.gz
 
# Trim adapters and low-quality bases from the Input control sample
echo "Processing Input control sample (Paired-End)..."
trim_galore --fastqc --cores 8 --quality 20 --stringency 3 --length 20 --paired \
    -o ~/GSE174602/trim \
    ~/GSE174602/raw/SRR14574895_Input_R1.fastq.gz \
    ~/GSE174602/raw/SRR14574895_Input_R2.fastq.gz
 
echo "Quality control and adapter trimming complete!"
# Trimmed files will be named like 'SRR14574894_SOX4_ChIP_R1_trimmed.fq.gz'

#-----------------------------------------------
#-----------------------------------------------
# STEP 3: Align reads to the reference genome hg38
#-----------------------------------------------
 
mkdir -p ~/GSE174602/bam
BAM_DIR=~/GSE174602/bam
TRIM_DIR=~/GSE174602/trim

# Use the absolute path for robustness for the reference genome
HOME_DIR=$(eval echo ~)
REFERENCE="${HOME_DIR}/BWA_Index_hg38/2230c535660fb4774114bfa966a62f823fdb6d21acf138d4.fa"
THREADS=16

# Define the exact names of the trimmed files generated by trim_galore
CHIP_R1="${TRIM_DIR}/SRR14574894_SOX4_ChIP_R1_val_1.fq.gz"
CHIP_R2="${TRIM_DIR}/SRR14574894_SOX4_ChIP_R2_val_2.fq.gz"
INPUT_R1="${TRIM_DIR}/SRR14574895_Input_R1_val_1.fq.gz"
INPUT_R2="${TRIM_DIR}/SRR14574895_Input_R2_val_2.fq.gz"
 
# 1. Align HA-SOX4 ChIP sample to the reference genome
echo "Aligning HA-SOX4 ChIP sample (Paired-End) to reference genome..."
bwa mem \
    -t ${THREADS} -M \
    -R "@RG\tID:HA-SOX4\tSM:HA-SOX4\tPL:ILLUMINA" \
    ${REFERENCE} \
    ${CHIP_R1} \
    ${CHIP_R2} \
    > ${BAM_DIR}/SRR14574894_SOX4_ChIP.sam
 
# 2. Align Input control sample to the reference genome
echo "Aligning Input control sample (Paired-End) to reference genome..."
bwa mem \
    -t ${THREADS} -M \
    -R "@RG\tID:INPUT\tSM:INPUT\tPL:ILLUMINA" \
    ${REFERENCE} \
    ${INPUT_R1} \
    ${INPUT_R2} \
    > ${BAM_DIR}/SRR14574895_Input.sam
 
echo "Alignment complete! Paired-end SAM files created."


#-----------------------------------------------
# STEP 4: Process and filter alignment files (Variables corrected for GSE174602)
#-----------------------------------------------
 

# Set variables for readability
HOME_DIR=$(eval echo ~)
PROJECT_DIR="${HOME_DIR}/GSE174602"
BAM_DIR="${PROJECT_DIR}/bam"
BLACKLIST_DIR="${HOME_DIR}/references/blacklists"

THREADS=16
SOX4_PREFIX="SRR14574894_SOX4_ChIP"
INPUT_PREFIX="SRR14574895_Input"

#=============================================
# 4.1: SAM to BAM conversion
#=============================================
echo "Converting SAM to BAM format..."
 
# Convert SOX4 ChIP sample
samtools view -h -S -b -@ ${THREADS} -o ${BAM_DIR}/${SOX4_PREFIX}.bam ${BAM_DIR}/${SOX4_PREFIX}.sam
 
# Convert Input control sample
samtools view -h -S -b -@ ${THREADS} -o ${BAM_DIR}/${INPUT_PREFIX}.bam ${BAM_DIR}/${INPUT_PREFIX}.sam
 
# Remove large SAM files
rm ${BAM_DIR}/${SOX4_PREFIX}.sam ${BAM_DIR}/${INPUT_PREFIX}.sam


#=============================================
# 4.2: Sort BAM files by genomic coordinates
#=============================================
echo "Sorting BAM files by chromosome position..."
THREADS=16

# Sort SOX4 ChIP sample with less memory per thread
samtools sort -@ ${THREADS} -m 512M -o ${BAM_DIR}/${SOX4_PREFIX}_sorted.bam ${BAM_DIR}/${SOX4_PREFIX}.bam

# Sort Input control sample with less memory per thread
samtools sort -@ ${THREADS} -m 512M -o ${BAM_DIR}/${INPUT_PREFIX}_sorted.bam ${BAM_DIR}/${INPUT_PREFIX}.bam

#=============================================
# 4.3: Index BAM files for random access
#=============================================
echo "Indexing BAM files for faster access..."
 
# Index SOX4 ChIP sample
samtools index -@ ${THREADS} ${BAM_DIR}/${SOX4_PREFIX}_sorted.bam
 
# Index Input control sample
samtools index -@ ${THREADS} ${BAM_DIR}/${INPUT_PREFIX}_sorted.bam
 
#=============================================
# 4.4: Mark and remove PCR duplicates
#=============================================
echo "Marking and removing PCR duplicates..."
 
# Process SOX4 ChIP sample
picard MarkDuplicates \
    I=${BAM_DIR}/${SOX4_PREFIX}_sorted.bam \
    O=${BAM_DIR}/${SOX4_PREFIX}_sorted_dedup.bam \
    M=${BAM_DIR}/${SOX4_PREFIX}_sorted_dedup_metrics.txt \
    REMOVE_DUPLICATES=true \
    VALIDATION_STRINGENCY=LENIENT
 
# Process Input control sample
picard MarkDuplicates \
    I=${BAM_DIR}/${INPUT_PREFIX}_sorted.bam \
    O=${BAM_DIR}/${INPUT_PREFIX}_sorted_dedup.bam \
    M=${BAM_DIR}/${INPUT_PREFIX}_sorted_dedup_metrics.txt \
    REMOVE_DUPLICATES=true \
    VALIDATION_STRINGENCY=LENIENT
 
# Index the deduplicated BAM files
samtools index ${BAM_DIR}/${SOX4_PREFIX}_sorted_dedup.bam
samtools index ${BAM_DIR}/${INPUT_PREFIX}_sorted_dedup.bam
 
#=============================================
# 4.5: Filter out blacklisted regions
#=============================================
echo "Downloading and preparing blacklist regions..."
 
# Download the ENCODE blacklist regions
mkdir -p ~/references/blacklists
cd ~/references/blacklists
wget https://github.com/Boyle-Lab/Blacklist/raw/master/lists/hg38-blacklist.v2.bed.gz
gunzip hg38-blacklist.v2.bed.gz
 
echo "Removing blacklisted regions from BAM files..."

# Filter HS-SOX4 ChIP sample
bedtools intersect \
    -v \                   # Only keep reads that DO NOT overlap blacklist
    -abam ${BAM_DIR}/${SOX4_PREFIX}_sorted_dedup.bam \  # Input BAM
    -b ~/references/blacklists/hg38-blacklist.v2.bed \  # Blacklist BED
    > ${BAM_DIR}/${SOX4_PREFIX}_sorted_dedup_filtered.bam  # Output filtered BAM
 
# Filter Input control sample
bedtools intersect \
    -v \
    -abam ${BAM_DIR}/${INPUT_PREFIX}_sorted_dedup.bam \
    -b ~/references/blacklists/hg38-blacklist.v2.bed \
    > ${BAM_DIR}/${INPUT_PREFIX}_sorted_dedup_filtered.bam
 
# Index the filtered BAM files
samtools index ${BAM_DIR}/${SOX4_PREFIX}_sorted_dedup_filtered.bam
samtools index ${BAM_DIR}/${INPUT_PREFIX}_sorted_dedup_filtered.bam
 
echo "Alignment processing and filtering complete!"
---------
# Define variables with absolute paths:
HOME_DIR=$(eval echo ~)
PROJECT_DIR="${HOME_DIR}/GSE174602"
BAM_DIR="${PROJECT_DIR}/bam"
BLACKLIST_DIR="${HOME_DIR}/references/blacklists"
SOX4_PREFIX="SRR14574894_SOX4_ChIP"
INPUT_PREFIX="SRR14574895_Input"
BLACKLIST=${BLACKLIST_DIR}/hg38-blacklist.v2.bed


# Filter SOX4 ChIP sample
bedtools intersect \
    -v \
    -abam ${BAM_DIR}/${SOX4_PREFIX}_sorted_dedup.bam \
    -b ${BLACKLIST} \
    > ${BAM_DIR}/${SOX4_PREFIX}_sorted_dedup_filtered.bam

# Filter Input control sample
bedtools intersect \
    -v \
    -abam ${BAM_DIR}/${INPUT_PREFIX}_sorted_dedup.bam \
    -b ${BLACKLIST} \
    > ${BAM_DIR}/${INPUT_PREFIX}_sorted_dedup_filtered.bam

# Index the filtered BAM files
samtools index ${BAM_DIR}/${SOX4_PREFIX}_sorted_dedup_filtered.bam
samtools index ${BAM_DIR}/${INPUT_PREFIX}_sorted_dedup_filtered.bam
echo "Alignment processing and filtering complete!"
#-----------------------------------------------

# STEP 5: Peak calling and annotation with HOMER
#-----------------------------------------------
 
# Use absolute paths
HOME_DIR=$(eval echo ~)
PROJECT_DIR="${HOME_DIR}/GSE174602"
BAM_DIR="${PROJECT_DIR}/bam"
HOMER_DIR="${PROJECT_DIR}/homer"

# Create directory for HOMER analysis
mkdir -p ${HOMER_DIR}
 
#=============================================
# 5.1: Create HOMER tag directories
#=============================================
echo "Creating HOMER tag directories..."
 
# Variables for readability
SOX4_PREFIX="SRR14574894_SOX4_ChIP"
INPUT_PREFIX="SRR14574895_Input"
 
# Define the full path to the *filtered* BAM files
CHIP_FILTERED_BAM="${BAM_DIR}/${SOX4_PREFIX}_sorted_dedup_filtered.bam"
INPUT_FILTERED_BAM="${BAM_DIR}/${INPUT_PREFIX}_sorted_dedup_filtered.bam"

# Create tag directory for SOX4 ChIP sample
echo "Creating tag directory for SOX4 ChIP sample..."
makeTagDirectory \
    ${HOMER_DIR}/${SOX4_PREFIX} \
    ${CHIP_FILTERED_BAM} \
    -genome hg38
 
# Create tag directory for Input control sample
echo "Creating tag directory for Input control sample..."
makeTagDirectory \
    ${HOMER_DIR}/${INPUT_PREFIX} \
    ${INPUT_FILTERED_BAM} \
    -genome hg38 
 
#=============================================
# 5.2: Call peaks to identify binding sites (Homer)
#=============================================
echo "Identifying peaks (protein binding sites)..."
 
findPeaks \
    ${HOMER_DIR}/${SOX4_PREFIX} \
    -style factor \
    -o ${HOMER_DIR}/${SOX4_PREFIX}/${SOX4_PREFIX}_peaks.tsv \
    -i ${HOMER_DIR}/${INPUT_PREFIX} \
    -fdr 0.001
 
#=============================================
# 5.3: Annotate peaks with genomic features
#=============================================
echo "Annotating peaks with genomic features..."
 
annotatePeaks.pl \
    ${HOMER_DIR}/${SOX4_PREFIX}/${SOX4_PREFIX}_peaks.tsv \
    hg38 \
    -go ${HOMER_DIR}/${SOX4_PREFIX}/go \
    -genomeOntology ${HOMER_DIR}/${SOX4_PREFIX}/genomeOntology \
    > ${HOMER_DIR}/${SOX4_PREFIX}/${SOX4_PREFIX}_peaks_annotated.tsv
 
echo "Peak calling and annotation complete! Check the output TSV files for results."


#-----------------------------------------------
# STEP 6: De novo and known motif discovery with HOMER
#-----------------------------------------------

echo "Starting motif discovery on identified peak regions..."

# Define variables for Step 6
PEAK_FILE="${HOMER_DIR}/${SOX4_PREFIX}/${SOX4_PREFIX}_peaks.tsv"
OUTPUT_MOTIF_DIR="${HOMER_DIR}/${SOX4_PREFIX}/motif_results"
mkdir -p ${OUTPUT_MOTIF_DIR}

findMotifsGenome.pl ${PEAK_FILE} hg38 ${OUTPUT_MOTIF_DIR} -size 200 -mask

echo "Motif discovery complete! Results are in ${OUTPUT_MOTIF_DIR}"

#-----------------------------------------------
# STEP 7: Prepare visualization files
#-----------------------------------------------
 
# Activate the HOMER environment
micromamba activate Env_Homer
 
#=============================================
# 7.1: Convert peak files to BED format
#=============================================
echo "Converting HOMER peaks to BED format..."
 
# First, get chromosome sizes for the reference genome
fetchChromSizes hg38 > ~/GSE174602/homer/hg38.chrom.sizes
 
# Convert HOMER peak file to BED format
pos2bed.pl ~/GSE174602/homer/SRR14574894_SOX4_ChIP/SRR14574894_SOX4_ChIP_peaks.tsv > ~/GSE174602/homer/SRR14574894_SOX4_ChIP/SRR14574894_SOX4_ChIP_peaks.bed
 
# Convert BED file to BigBed format
LC_ALL=C sort -k1,1 -k2,2n \
~/GSE174602/homer/SRR14574894_SOX4_ChIP/SRR14574894_SOX4_ChIP_peaks.bed \
-o ~/GSE174602/homer/SRR14574894_SOX4_ChIP/SRR14574894_SOX4_ChIP_peaks_sorted.bed
 
bedToBigBed ~/GSE174602/homer/SRR14574894_SOX4_ChIP/SRR14574894_SOX4_ChIP_peaks_sorted.bed ~/GSE174602/homer/hg38.chrom.sizes ~/GSE174602/homer/SRR14574894_SOX4_ChIP/SRR14574894_SOX4_ChIP_peaks_sorted.bb
 
#=============================================
# 7.2: Create signal tracks (bigWig files)
#=============================================
echo "Creating signal tracks for visualization..."
 
# Make bigWig files using HOMER (normalized against Input)
makeUCSCfile \
    ~/GSE174602/homer/SRR14574894_SOX4_ChIP \     # Tag directory for ChIP sample
    -o auto \                               # Auto-generate output name
    -i ~/GSE174602/homer/SRR14574894_SOX4_Input \  # Input control
    -bigWig ~/GSE174602/homer/hg38.chrom.sizes \  # Chromosome sizes
    -style chipseq                          # ChIP-seq style normalization
 
# Make bigWig files using deepTools
 
# Create bigWig for ChIP sample
bamCoverage \
    --bam ~/GSE174602/bam/SRR14574894_SOX4_ChIP_sorted_dedup_filtered.bam \  # Input BAM
    --outFileName ~/GSE174602/homer/SRR14574894_SOX4_ChIP/SRR14574894_SOX4_ChIP.deeptools.bw \  # Output
    --binSize 10 \                          # Resolution (10bp bins)
    --normalizeUsing RPKM \                 # Normalize for sequencing depth
    --effectiveGenomeSize 2913022398 \      # Effective size of hg38
    --numberOfProcessors 8                  # Use 8 CPU cores
# Create bigWig for Input control
bamCoverage \
    --bam ~/GSE174602/bam/SRR14574895_Input_sorted_dedup_filtered.bam \
    --outFileName ~/GSE174602/homer/SRR14574895_Input/SRR14574895_Input.deeptools.bw \
    --binSize 10 \
    --normalizeUsing RPKM \
    --effectiveGenomeSize 2913022398 \
    --numberOfProcessors 8
 
echo "Visualization files prepared successfully!"

#=============================================
# 7.3: plotProfile
printf "chr6\t41072946\t41102403\tNFYA\n" > geneNFYA.bed


computeMatrix scale-regions \
  -S ~/GSE174602/homer/SRR14574894_SOX4_ChIP/SRR14574894_SOX4_ChIP.deeptools.bw ~/GSE174602/homer/SRR14574895_Input/SRR14574895_Input.deeptools.bw \
  -R geneNFYA.bed \
  --beforeRegionStartLength 3000 \
  --regionBodyLength 5000 \
  --afterRegionStartLength 3000 \
  --skipZeros \
  -o matrix_geneNFYA.gz

  plotProfile -m matrix_geneNFYA.gz \
     -out NFYA_TSS_merged.png \
     --plotType fill \
     --perGroup \
     --colors red blue \
     --samplesLabel "SOX4_ChIP" "Input" \
     --regionsLabel "NFYA" \
